{% extends "template.html" %}
{% block content%}
<header class="header">
    <nav class="header_menu">
        <div class = "nav_menu">
            <a class="header_menu_link" href="{{ url_for('home.index') }}">Home</a>
            <a class="header_menu_link" href="{{ url_for('higher_lower.home') }}">Higher Lower Game</a>
            <p class="header_menu_link">Who's that Pokémon</p>
        </div>
        <div class = "toogle_menu">
            <img src="{{ url_for('static', filename='assets/sun.png') }}" alt="Day Mode" class="toggle_icon">
            <label class="toggle-btn">
                <input type="checkbox" id="toggleBackground">
                <span class="slider"></span>
            </label>
            <img src="{{ url_for('static', filename='assets/moon.png') }}" alt="Night Mode" class="toggle_icon">
        </div>
    </nav>
</header>

<main class="main_content">
    <h1 class="main_content_title">Who's that Pókemon? </h1>
    <div class="score-container">
        <h2 class="main_content_text" id="score">Score: 0</h2>
        <h2 class="main_content_text" id="high_score">High Score: {{high_score_wtp}}</h2>
    </div>

    <section class="pokemon_wtp" id="pkmn">
        <div class = 'guess_pkmn'> 
            <h2 class="main_content_text" id="name_pkmn">?</h2>
            <img src="{{ pkmn.shadow_sprite }}" alt="Pokemon" id_name="{{ pkmn.id_name }}" id="pokemonImage" sprite="{{pkmn.sprite}}">
        </div>
        <div class="forms">
            <form action="/whos_that_pkmn" method="post" id="gameForm">
                <div class = 'guess_panel'>
                    <div class = 'guess_pkmn_list'>
                        <h2> Choose One Pokemon from the list below</h2>
                        <select id="generation-filter">
                            <option value="All">All Generations</option>
                            {% for gen in generations_dict.keys() %}
                            <option value="{{ gen }}">{{ gen }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" id="global-filter" placeholder="Filter Pokémon Name">
                        <div class="scrollable-list" id="pokemon-list">
                            <!-- items will be populated by JavaScript -->
                        </div>
                        
                        <div class="submit-container">
                            <input id='submit_forms' type="submit" value="Guess">
                        </div>
                    </div>
                 
                </div>
            </form>
        </div>
    </section>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to exit? You'll lose your current progress!</p>
            <button class="confirmation_button" id="confirmYes">Yes</button>
            <button class="confirmation_button" id="confirmNo">No</button>
        </div>
    </div>
</main>

<script type="text/javascript">
    let score = 0;
    generations_dict = {{ generations_dict | tojson | safe }};

    // Alert the user when they attempt to navigate to another page
    document.addEventListener('DOMContentLoaded', function() {
        let showUnloadAlert = true;

        const links = document.querySelectorAll('a');
        const confirmModal = document.getElementById('confirmModal');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        let currentLink = null;

        for(let link of links) {
            link.addEventListener('click', function(event) {
                if (showUnloadAlert) {
                    event.preventDefault();
                    currentLink = link.getAttribute('href');
                    confirmModal.style.display = 'block';
                }
            });
        }

        confirmYes.addEventListener('click', function() {
            window.location.href = currentLink;
        });

        confirmNo.addEventListener('click', function() {
            confirmModal.style.display = 'none';
            currentLink = null;
        });
    });

    // When the generation filter changes, update the list with both filters
    document.getElementById('generation-filter').addEventListener('change', function() {
        const genFilter = this.value;
        const textFilter = document.getElementById('global-filter').value;
        updateList(textFilter, genFilter);
    });

    // When the text filter changes, update the list with both filters
    document.getElementById('global-filter').addEventListener('input', function() {
        const textFilter = this.value;
        const genFilter = document.getElementById('generation-filter').value;
        updateList(textFilter, genFilter);
    });

    // Initialize the list on page load
    document.addEventListener('DOMContentLoaded', () => {
        const textFilter = document.getElementById('global-filter').value;
        const genFilter = document.getElementById('generation-filter').value;
        updateList(textFilter, genFilter);
    });

    // Initialize the list on page load
    document.addEventListener('DOMContentLoaded', () => {
        initializeLists(); 
    });

    // Logic for form submission
    document.getElementById('gameForm').onsubmit = function(event) {
        event.preventDefault();

        var selectedPokemon = document.querySelector('input[name="selected_pokemon"]:checked');
        var filterInput = document.getElementById('global-filter');
        var genFilter = document.getElementById('generation-filter');
        if(selectedPokemon){
            filterInput.value = '';
            genFilter.value = 'All';
            updateList();
            checkWinner(selectedPokemon);
        } else {
            alert('No Pokémon selected');
            event.preventDefault(); // Prevents the form from being submitted if no Pokémon is selected
        }
    };

    // Function to filter all lists based on the value of the global filter
    function filterAllLists() {
        var filterValue = document.getElementById('global-filter').value.toLowerCase();
        var listItems = document.querySelectorAll('.scrollable-list .pokemon-list');

        listItems.forEach(function(item) {
            var text = item.textContent.toLowerCase();
            if (text.includes(filterValue)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function updateList(textFilter = '', genFilter = 'All') {
        const listId = 'pokemon-list';
        const ul = document.getElementById(listId);
        if (!ul) return; // Exits the function if the list item is not found

        ul.innerHTML = ''; // Clears the current list

        // Filters by generation first, if necessary
        let filteredGenerations = genFilter === 'All' ? Object.values(generations_dict) : [generations_dict[genFilter]];

        // Combines all arrays of id_names into a single array and filters by text
        filteredGenerations.flat()
            .filter(name => name.toLowerCase().includes(textFilter.toLowerCase()))
            .forEach(name => {
                // Creation and addition of list elements as before
                const div = document.createElement('div');
                div.className = 'custom-radio';
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = name;
                input.name = 'selected_pokemon';
                input.value = name;
                const label = document.createElement('label');
                label.htmlFor = name;
                label.textContent = name;

                div.appendChild(input);
                div.appendChild(label);
                ul.appendChild(div);
            });
    }

    // Function to initialize the lists the first time the page loads
    function initializeLists() {
        updateList(); // Initializes with all items
        // Sets up the generation filter
        document.getElementById('generation-filter').addEventListener('change', function() {
            const gen = this.value;
            const globalFilter = document.getElementById('global-filter').value;
            updateList(globalFilter, gen); // Updates the list with the global and generation filters
        });
    }

    // Function to switch Pokemon Sprite 
    function switchPokemonSprite(newSpriteSrc) {
        var pokemonSprite = document.getElementById('pokemonImage');
        pokemonSprite.src = newSpriteSrc;
        setTimeout(() => {
                        console.log('Switching sprite...'); 
                        }, 500);
    }

    // Function to check if user got the right answer
    function checkWinner(pkmnElem) {
        
        var selectedPkmn = pkmnElem.value;
        var pokemonImage = document.getElementById('pokemonImage');
        var pokemonName = pokemonImage.getAttribute('id_name');
        var pokemonSprite = pokemonImage.getAttribute('sprite');

        if (selectedPkmn == pokemonName) {
            userAction(true);
            score += 1;
            document.getElementById('score').textContent = "Score: " + score;

            Promise.all([
                switchPokemonSprite(pokemonSprite)
            ]).then(() => {
                document.getElementById('name_pkmn').textContent = pokemonName;
                setTimeout(() => {
                    redrawPokemons(pkmnElem);
                }, 1500);
            });

        } else {
            userAction(false);
            score = 0; 
            Promise.all([
                switchPokemonSprite(pokemonSprite)
            ]).then(() => {
                document.getElementById('name_pkmn').textContent = pokemonName;
                setTimeout(() => {
                    postToURL("/whos_that_pkmn", { game_end_arg: "end" });
                }, 1500);
            });
        }
    }

    // Function to request new Pokemon to server
    function redrawPokemons(pkmnElem) {
        var selectedPkmn = pkmnElem.value;
        var pokemonImage = document.getElementById('pokemonImage');
        var pokemonName = pokemonImage.getAttribute('id_name');
        var pokemonSprite = pokemonImage.getAttribute('sprite');

        // Request server to redraw Pokemon
        fetch(`/redraw_pokemons_wtp`)
        .then(response => response.json())
        .then(data => {
            // Check if Game ended
            if (data.game_end == 'True') {
                Promise.all([
                    switchPokemonSprite(pokemonSprite)
                ]).then(() => {
                    document.getElementById('name_pkmn').textContent = pokemonName;
                    postToURL("/whos_that_pkmn", { game_end_arg: "end_full" });
                });
            }
            else{
                // Current Pokemon Element
                const newPokemonDiv = document.getElementById('pkmn');

                // Update the Pokémon based on the div ID
                document.getElementById('name_pkmn').textContent = '?';
                newPokemonDiv.querySelector('img').src = data.shadow_sprite;
                newPokemonDiv.querySelector('img').setAttribute('id_name', data.id_name);
                newPokemonDiv.querySelector('img').setAttribute('sprite', data.sprite);
            }
        });
    }
</script>
{% endblock %}
