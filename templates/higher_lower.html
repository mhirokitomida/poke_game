{% extends "template.html" %}
{% block conteudo %}
<header class="cabecalho">
    <nav class="cabecalho__menu">
        <div class = "nav_menu">
            <a class="cabecalho__menu__link" href="{{ url_for('index') }}">Home</a>
            <p class="cabecalho__menu__link">Higher Lower Game</p>
            <a class="cabecalho__menu__link" href="{{ url_for('whos_that_pkmn_home') }}">Who's that Pokémon</a>
        </div>
        <div class = "toogle_menu">
            <img src="{{ url_for('static', filename='assets/sun.png') }}" alt="Day Mode" class="toggle_icon">
            <label class="toggle-btn">
                <input type="checkbox" id="toggleBackground">
                <span class="slider"></span>
            </label>
            <img src="{{ url_for('static', filename='assets/moon.png') }}" alt="Night Mode" class="toggle_icon">
        </div>
    </nav>
</header>

<main class="apresentacao">
    <h1 class="apresentacao__conteudo__titulo" id="stat">Stat: {{ stat }}</h1>
    <div class="score-container">
        <h2 class="apresentacao__conteudo__titulo" id="score">Score: 0</h2>
        <h2 class="apresentacao__conteudo__titulo" id="high_score">High Score: {{high_score_hl}}</h2>
    </div>

    <section class="pokemon_battle">
        <div class="pokemon" id="pkmn"> 
            <h2 class="apresentacao__conteudo__titulo">{{ pkmn.nome }}</h2>
            <img src="{{ pkmn.sprite }}" alt="Pokemon 1" data-stat="{{ pkmn.stat }}">
            <h3 class="apresentacao__conteudo__titulo" id="stat-pkmn"></h3>
        </div>
        <h2 id="vs">VS</h2> 
        <div class="pokemon" id="pkmn-2"> 
            <h2 class="apresentacao__conteudo__titulo">{{ pkmn_2.nome }}</h2>
            <img src="{{ pkmn_2.sprite }}" alt="Pokemon 2" data-stat="{{ pkmn_2.stat }}">
            <h3 class="apresentacao__conteudo__titulo" id="stat-pkmn-2"></h3>
        </div>
    </section>
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to exit? You'll lose your current progress!</p>
            <button class="confirmation_button" id="confirmYes">Yes</button>
            <button class="confirmation_button" id="confirmNo">No</button>
        </div>
    </div>
</main>

<script>
let score = 0;
let lastChangedPkmnId = null;


document.addEventListener('DOMContentLoaded', function() {
    let showUnloadAlert = true;

    const links = document.querySelectorAll('a');
    const confirmModal = document.getElementById('confirmModal');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    let currentLink = null;

    for(let link of links) {
        link.addEventListener('click', function(event) {
            if (showUnloadAlert) {
                event.preventDefault();
                currentLink = link.getAttribute('href');
                confirmModal.style.display = 'block';
            }
        });
    }

    confirmYes.addEventListener('click', function() {
        window.location.href = currentLink;
    });

    confirmNo.addEventListener('click', function() {
        confirmModal.style.display = 'none';
        currentLink = null;
    });
});

function animateStat(elementId, targetValue, stat_used) {
    let currentValue = 0;
    const value = (stat_used == 'total') ? 30 : 5;
    let elementToShow = document.getElementById(elementId);

    if (elementToShow) {
        elementToShow.style.visibility = "visible";
    } else {
        console.error(`Element with ID ${elementId} not found.`);
    }

    return new Promise((resolve) => {
        function increaseStat() {
            if (currentValue < targetValue) {
                currentValue += value;
                if (currentValue > targetValue) {
                    currentValue = targetValue;
                }
                document.getElementById(elementId).textContent = currentValue;
                requestAnimationFrame(increaseStat);
            } else if (targetValue === 0) {
                document.getElementById(elementId).textContent = '?';
            } else {
                setTimeout(() => {
                    resolve(); 
                }, 500);
                
            }
        }
        increaseStat();
    });
}

function userAction(isCorrect) {
    const apresentacao = document.querySelector('.apresentacao');

    if (isCorrect) {
        apresentacao.classList.add('correct');
        setTimeout(() => {
            apresentacao.classList.remove('correct');
        }, 500);
    } else {
        apresentacao.classList.add('wrong');
        setTimeout(() => {
            apresentacao.classList.remove('wrong');
        }, 500);
    }
}

function postToURL(url, data) {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = url;

    for (var key in data) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = data[key];
        form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
}

function checkWinner(selectedPkmn) {
    
    const statUsed = document.getElementById('stat').textContent;
    const pkmnElem = document.getElementById('pkmn').querySelector('img');
    const pkmn2Elem = document.getElementById('pkmn-2').querySelector('img');

    const selectedStat = parseInt(selectedPkmn.getAttribute('data-stat'));
    const otherPkmn = selectedPkmn === pkmnElem ? pkmn2Elem : pkmnElem;
    const otherStat = parseInt(otherPkmn.getAttribute('data-stat'));

    if (selectedStat >= otherStat) {
        userAction(true);
        score += 1;
        document.getElementById('score').textContent = "Score: " + score;

        let parentDivId;
        if (!lastChangedPkmnId) {
            parentDivId = selectedPkmn === pkmnElem ? "pkmn" : "pkmn-2";
        } else {
            parentDivId = lastChangedPkmnId === "pkmn" ? "pkmn-2" : "pkmn";
        }
        lastChangedPkmnId = parentDivId; 

        ressortearPokemons(parentDivId);

    } else {
        userAction(false);
        score = 0; 
        document.getElementById('pkmn').classList.add('disabled');
        document.getElementById('pkmn-2').classList.add('disabled');
        Promise.all([
            animateStat("stat-pkmn", parseInt(pkmnElem.getAttribute('data-stat')), statUsed),
            animateStat("stat-pkmn-2", parseInt(pkmn2Elem.getAttribute('data-stat')), statUsed)
        ]).then(() => {
            postToURL("/higher_lower", { game_end_arg: "end" });
        });
    }
}

function ressortearPokemons(lastChangedPkmnId) {
    document.getElementById('pkmn').classList.add('disabled');
    document.getElementById('pkmn-2').classList.add('disabled');
    const statUsed = document.getElementById('stat').textContent;
    const pkmnElem = document.getElementById('pkmn').querySelector('img');
    const pkmn2Elem = document.getElementById('pkmn-2').querySelector('img');

    fetch(`/resort_pokemons_hl?last_id=${lastChangedPkmnId}`)
    .then(response => response.json())
    .then(data => {
        if (data.game_end == 'True') {
            Promise.all([
                animateStat("stat-pkmn", parseInt(pkmnElem.getAttribute('data-stat')), statUsed),
                animateStat("stat-pkmn-2", parseInt(pkmn2Elem.getAttribute('data-stat')), statUsed)
            ]).then(() => {
                postToURL("/higher_lower", { game_end_arg: "end_full" });
            });
        }
        else{
            Promise.all([
                animateStat("stat-pkmn", parseInt(pkmnElem.getAttribute('data-stat')), statUsed),
                animateStat("stat-pkmn-2", parseInt(pkmn2Elem.getAttribute('data-stat')), statUsed)
            ]).then(() => {
                const statDiv = document.getElementById('stat');
                statDiv.textContent = data.random_stat;
                const statUsed = statDiv.textContent;
        
                const [newPokemonDiv, oldPokemonDiv] = lastChangedPkmnId === 'pkmn' ? 
                [document.getElementById('pkmn-2'), document.getElementById('pkmn')] : 
                [document.getElementById('pkmn'), document.getElementById('pkmn-2')];

                // Update the Pokémon based on the div ID
                newPokemonDiv.querySelector('h2').textContent = data.novo_pokemon.nome;
                newPokemonDiv.querySelector('img').src = data.novo_pokemon.sprite;
                newPokemonDiv.querySelector('img').setAttribute('data-stat', data.novo_pokemon.stat);

                oldPokemonDiv.querySelector('h2').textContent = data.old_pokemon.nome;
                oldPokemonDiv.querySelector('img').src = data.old_pokemon.sprite;
                oldPokemonDiv.querySelector('img').setAttribute('data-stat', data.old_pokemon.stat);

                setTimeout(() => {
                    document.getElementById('pkmn').classList.remove('disabled');
                    document.getElementById('pkmn-2').classList.remove('disabled');
                    document.getElementById("stat-pkmn").style.visibility = "hidden";
                    document.getElementById("stat-pkmn-2").style.visibility = "hidden";
                }, 800);
            });
        }
    });
}

document.querySelector('.pokemon_battle').addEventListener('click', function(event) {
    if (event.target.tagName === 'IMG') {
        checkWinner(event.target);
    }
});
</script>
{% endblock %}
